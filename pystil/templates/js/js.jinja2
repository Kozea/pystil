$(function () {
    var graphs = [
        {
            name: 'by_hour',
            url:  "{{ url_for('visit_by_hour')}}",
            style: {
                width: '800px',
                height: '300px'
            },
            options: {
                bars: { show: true, fill: true },
                grid: { hoverable: true },
                xaxis: { min: 0, max: 23, ticks: 24, tickDecimals: 0 },
                yaxis: { tickDecimals: 0 }
            },
            data: function (response) {
                return [response];
            },
            tooltip: function (item) {
                var x = item.datapoint[0],
                y = item.datapoint[1];
                return y + " visits at " + x + " h";
            }
        }, {
            name: 'by_day',
            url:  "{{ url_for('visit_by_day') }}",
            style: {
                width: '800px',
                height: '300px'
            },
            options: {
                lines: { show: true, fill: true },
                points: { show: true, fill: true },
                grid: { hoverable: true },
                xaxis: {
                    mode: "time",
                    timeformat: "%y-%0m-%0d"
                },
                yaxis: { tickDecimals: 0 }
            },
            data: function (response) {
                return [response];
            },
            tooltip: function (item) {
                var x = item.datapoint[0],
                y = item.datapoint[1];
                return y + " visits on " + $.plot.formatDate(new Date(x), "%y-%0m-%0d");
            }
        }, {
            name: 'by_browser',
            url:  "{{ url_for('visit_by_browser') }}",
            style: {
                width: '400px',
                height: '400px'
            },
            options: {
                grid: { hoverable: true },
                series: {
                    pie: { show: true }
                }
            },
            data: function (response) {
                return response.list;
            },
            tooltip: function (item) {
                return "Lol";
            }
        }
    ];
    var showTooltip = function (x, y, contents) {
        $('<div>').attr('id', 'tooltip').css( {
            position: 'absolute',
            display: 'none',
            top: y + 5,
            left: x + 5,
            border: '1px solid #fdd',
            padding: '2px',
            'background-color': '#fee',
            opacity: 0.80
        }).text(contents).appendTo("body").fadeIn(200);
    };
    for(var i in graphs) {
        var g = graphs[i];
        $("#graphs").append(
            $('<div>').attr('id', g.name).css(g.style));
        var elt = $("#" + g.name);
        var plot = $.plot(elt, [], g.options);
        // Keep the closures FFS
        var success = function (g, elt) {
            return function (response) {
                plot = $.plot(elt, g.data(response), g.options);
            };
        }(g, elt);
        $.ajax({
            url: g.url,
            method: 'GET',
            dataType: 'json',
            success: success
        });


        var previousPoint = null;
        elt.bind("plothover", function (g) {
            return function (event, pos, item) {
                if (item) {
                    if (previousPoint != item.dataIndex) {
                        previousPoint = item.dataIndex;

                        $("#tooltip").remove();
                        showTooltip(item.pageX, item.pageY, g.tooltip(item));
                    }
                }
                else {
                    $("#tooltip").remove();
                    previousPoint = null;
                }
            };
        }(g));
    }
});
