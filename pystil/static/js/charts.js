// Generated by CoffeeScript 1.6.2
(function() {
  $(function() {
    var get_dates, load_embed, load_embed_maybe, make_url;

    get_dates = function() {
      return $.datepicker.formatDate('yy-mm-dd', $("#from").datepicker("getDate")) + '/' + $.datepicker.formatDate('yy-mm-dd', $("#to").datepicker("getDate"));
    };
    make_url = function(url) {
      if (url.indexOf('/load') !== 0) {
        url = '/load' + url;
      }
      if (url.indexOf('/between') > -1) {
        url = url.split('/between')[0];
      }
      if ($('.datepicker').length) {
        url = url.replace('.svg', '') + '/between/' + get_dates() + '.svg';
      }
      return url;
    };
    $('form.from-to').on('submit', function() {
      $('embed').each(function() {
        var after_load, url;

        url = make_url($(this).attr('src'));
        after_load = function($old, $new) {
          return setTimeout((function() {
            $new.trigger('load');
            return setTimeout((function() {
              return load_embed_maybe($new);
            }), 100);
          }), 100);
        };
        return load_embed_maybe(this, url, after_load);
      });
      return false;
    });
    $('i.load').click(function() {
      return $('form.from-to').submit();
    });
    load_embed_maybe = function(embed, url, callback) {
      var $new;

      if (url == null) {
        url = null;
      }
      if (callback == null) {
        callback = null;
      }
      if ($(embed).closest('figure').data('loading') || ($(embed).width() === 300 && $(embed).height() === 150)) {
        setTimeout((function() {
          return load_embed_maybe(embed, url, callback);
        }), 250);
        return;
      }
      $new = load_embed(embed, url);
      if (callback) {
        return callback($(embed), $new);
      }
    };
    load_embed = function(embed, url) {
      var $figure, $loading, $new;

      if (url == null) {
        url = null;
      }
      $loading = $(embed);
      url = url || make_url($loading.attr('src')).replace('/load', '');
      $figure = $loading.closest('figure');
      $figure.data('loading', true);
      if (!$figure.attr('style')) {
        $figure.width($loading.width()).height($loading.height()).css({
          overflow: 'hidden'
        });
      }
      $figure.append($new = $('<embed>', {
        type: 'image/svg+xml',
        src: url
      }).on('load', function() {
        $(this).prev().remove();
        return $(this).closest('figure').data('loading', false);
      }));
      return $new;
    };
    window._pystil_init_embed = function() {
      return $('embed[src^="/load"]').on('load', function() {
        return load_embed_maybe(this);
      });
    };
    return window._pystil_init_embed();
  });

}).call(this);

/*
//@ sourceMappingURL=charts.map
*/
