(function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};this.Base=function(){function b(b){this.elt=b,this.reply=a(this.reply,this),this.elt.addClass("loading"),this.criteria=this.elt.attr("data-criteria").split(","),this.remaining_criteria=this.criteria.length,this.fetch()}return b.prototype.fetch=function(){return $.ajax({url:this.url(),method:"GET",dataType:"json",success:this.reply})},b.prototype.clear=function(){return this.remaining_criteria=this.criteria.length},b.prototype.reply=function(a){this.elt.removeClass("loading");if(this.remaining_criteria>0)return this.fetch()},b.prototype.url=function(){var a,b;return b=location.pathname.split("/")[1]||"all",a="/"+b+"/"+this.type+"_by_"+this.criteria[--this.remaining_criteria],this.stamp?a+="_at_"+this.stamp:a+="_from_"+window.fromDate.getTime()+"_to_"+window.toDate.getTime(),""+a+".json"},b}(),this.Map=function(){function b(c){this.elt=c,this.reply=a(this.reply,this),this.data=[],$("body").append($("<div>").attr("id","maptooltip").css({position:"absolute",display:"none"})),$.ajax({url:"/static/worldmap.svg",method:"GET",dataType:"html",async:!1,success:a(function(a){return this.elt.html(a)},this)}),this.plotable=!0,b.__super__.constructor.apply(this,arguments)}return c(b,this.Base),b.prototype.type="map",b.prototype.clear=function(){return b.__super__.clear.apply(this,arguments),$(".country").css({fill:""}).find("title").remove()},b.prototype.reply=function(a){return b.__super__.reply.apply(this,arguments),this.data=a,this.plot(),this.make_tooltip()},b.prototype.plot=function(){var a,b,c,d,e;d=this.data.list,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push($("#"+a.key.split("$")[1].toLowerCase()).css({fill:"rgba(0, 0, 255, "+(a.count/this.data.max*.7+.2)+")"}).prepend($("<title>").text(a.key.split("$")[0].toLowerCase()+": "+a.count)));return e},b.prototype.make_tooltip=function(){return $(".country").mouseover(function(a){return $("#maptooltip").css({top:a.pageY+10+"px",left:a.pageX+10+"px",display:"block"}).text($("title",a.currentTarget).text())}),$(".country").mouseout(function(a){return $("#maptooltip").css({display:"none"})})},b}.call(this),this.Graph=function(){function b(c){this.elt=c,this.plothover=a(this.plothover,this),this.reply=a(this.reply,this),this.data=[],this.plotable=!0,b.__super__.constructor.apply(this,arguments),this.old_index=null,this.elt.bind("plothover",this.plothover)}return c(b,this.Base),b.prototype.reply=function(a){var c,d,e,f;b.__super__.reply.apply(this,arguments);if(a.list){f=a.list;for(d=0,e=f.length;d<e;d++)c=f[d],this.data.push(c)}else this.data.push(a);return this.plot()},b.prototype.clear=function(){return b.__super__.clear.apply(this,arguments),this.data=[]},b.prototype.plot=function(){return $.plot(this.elt,this.data,this.options)},b.prototype.plothover=function(a,b,c){var d;if(!c)return $("#tooltip").remove(),this.old_index=null;d=c.series.pie.show?c.seriesIndex:c.dataIndex;if(this.old_index!==d)return this.old_index=d,$("#tooltip").remove(),$("<div>").attr("id","tooltip").css({top:b.pageY+5,left:b.pageX+5,border:"1px solid "+c.series.color}).text(this.tooltip(c)).appendTo("body")},b}.call(this),this.Line=function(){function a(){a.__super__.constructor.apply(this,arguments)}return c(a,this.Graph),a.prototype.type="line",a.prototype.options={lines:{show:!0,fill:!0},points:{show:!0,fill:!0},grid:{hoverable:!0},xaxis:{mode:"time",timeformat:"%y-%0m-%0d"},yaxis:{tickDecimals:0}},a.prototype.tooltip=function(a){var b,c;return c=a.datapoint[1],b=new Date(a.datapoint[0]),c+" "+a.series.label.toLowerCase()+" on "+b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()},a}.call(this),this.Bar=function(){function a(){a.__super__.constructor.apply(this,arguments)}return c(a,this.Graph),a.prototype.type="bar",a.prototype.options={bars:{show:!0,fill:!0},grid:{hoverable:!0},xaxis:{min:0,max:23,ticks:24,tickDecimals:0},yaxis:{tickDecimals:0}},a.prototype.tooltip=function(a){var b,c;return b=a.datapoint[0],c=a.datapoint[1],c+" visits at "+b+" h"},a}.call(this),this.Time=function(){function a(){a.__super__.constructor.apply(this,arguments)}return c(a,this.Bar),a.prototype.options={bars:{show:!0,fill:!0},grid:{hoverable:!0},xaxis:{min:0,max:60,tickDecimals:0},yaxis:{tickDecimals:0}},a.prototype.tooltip=function(a){var b,c;return b=a.datapoint[0],c=a.datapoint[1],c+" visits during between "+b+" and  "+(b+1)+" minutes"},a}.call(this),this.Pie=function(){function a(){a.__super__.constructor.apply(this,arguments)}return c(a,this.Graph),a.prototype.type="pie",a.prototype.options={grid:{hoverable:!0},series:{pie:{show:!0}}},a.prototype.tooltip=function(a){var b;return b=a.datapoint[0],a.series.label+": "+b.toFixed(1)+"%"},a}.call(this),this.Last=function(){function b(c){var d,e,f,g,h,i;this.elt=c,this.update=a(this.update,this),this.ask_update=a(this.ask_update,this),this.reply=a(this.reply,this),this.stamp=0,b.__super__.constructor.apply(this,arguments),this.elt.append(e=$("<table>").append($("<thead>").append(f=$("<tr>")))),i=["Date","Site","Ip","Country","City","Page","Referrer"];for(g=0,h=i.length;g<h;g++)d=i[g],f.append($("<th>").text(d));e.append(this.tbody=$("<tbody>"))}return c(b,this.Base),b.prototype.type="last",b.prototype.reply=function(a){return b.__super__.reply.apply(this,arguments),this.update(a)},b.prototype.ask_update=function(){return this.remaining_criteria=1,$.ajax({url:this.url(),method:"GET",dataType:"json",success:this.update})},b.prototype.update=function(a){var b,c,d,e,f,g;if(a.list.length>0)for(b=1,f=a.list.length;1<=f?b<=f:b>=f;1<=f?b++:b--)this.tbody.children().last().remove();g=a.list;for(d=0,e=g.length;d<e;d++)c=g[d],this.tbody.prepend($("<tr>").addClass("new-visit").append($("<td>").text(c.date)).append($("<td>").text(c.host)).append($("<td>").text(c.ip)).append($("<td>").text(c.country)).append($("<td>").text(c.city)).append($("<td>").text(c.page)).append($("<td>").text(c.referrer)));return setTimeout(function(){return $(".new-visit").each(function(a,b){return $(b).removeClass("new-visit")})},1e3),this.stamp=a.stamp,setTimeout(this.ask_update,2500)},b}.call(this),$(a(function(){var b,c,d,e,f,g;c=[],$(".datepicker").datepicker({onSelect:a(function(a,b){var d,e,f,g;this[b.id+"Date"]=new Date(a),g=[];for(e=0,f=c.length;e<f;e++)d=c[e],g.push(d.plotable?(d.clear(),d.fetch()):void 0);return g},this),dateFormat:"yy-mm-dd",maxDate:new Date}),$("#from").datepicker("setDate","-1m"),$("#to").datepicker("setDate",new Date),this.fromDate=$("#from").datepicker("getDate"),this.toDate=$("#to").datepicker("getDate"),f=$(".graph"),g=[];for(d=0,e=f.length;d<e;d++)b=f[d],b=$(b),g.push(c.push(new(this[b.attr("data-graph")])(b)));return g},this))}).call(this)